<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPN QR Generator</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--accent:#22d3ee;--ok:#10b981;--err:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    .wrap{min-height:100dvh;background:linear-gradient(120deg,#0f172a,#020617);color:white;display:grid;place-items:start;align-content:start;padding:24px}
    .container{width:100%;max-width:980px;margin-inline:auto;display:grid;gap:16px}
    header{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,#22d3ee,#0891b2);color:#00151a;font-weight:800}
    h1{font-size:clamp(22px,3vw,34px);margin:0 0 8px 0}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .grid{display:grid;gap:10px;grid-template-columns:1fr}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:720px){.row{grid-template-columns:repeat(3,1fr)}}
    label{font-size:13px;color:#cbd5e1}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;outline:none}
    input::placeholder{color:#64748b}
    input.err{border-color:var(--err);box-shadow:0 0 0 1px var(--err)}
    .card{background:rgba(255,255,255,0.02);border:1px solid rgba(148,163,184,0.14);border-radius:16px;padding:16px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid #1f2937;background:#0b1220;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#0891b2,#22d3ee);color:#00151a;border:0;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid #334155}
    .muted{color:var(--muted);font-size:12px}
    .qrbox{display:grid;gap:10px;place-items:center;padding:16px;border-radius:16px;background:#020617;border:1px dashed #334155;min-height:360px}
    canvas{image-rendering:pixelated;background:#fff;border-radius:8px}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">QR</div>
      <div>
        <h1>UPN QR Generator</h1>
        <div class="sub">Vnesi osnovne podatke in ustvari UPN QR kodo, združljivo z vsemi bankami.</div>
      </div>
    </header>

    <section class="card">
      <div class="grid">
        <div class="row">
          <div>
            <label>Prejemnik – naziv</label>
            <input id="ime_prejemnika" placeholder="Janez Novak">
          </div>
          <div>
            <label>Prejemnik – ulica in št.</label>
            <input id="ulica_prejemnika" placeholder="Glavna cesta 10">
          </div>
          <div>
            <label>Prejemnik – kraj (pošta in mesto)</label>
            <input id="kraj_prejemnika" placeholder="1000 Ljubljana">
          </div>
        </div>

        <div class="row">
          <div>
            <label>IBAN prejemnika</label>
            <input id="IBAN_prejemnika" placeholder="SI56 0000 0000 0000 000">
          </div>
          <div>
            <label>Namen plačila</label>
            <input id="namen_placila" placeholder="Storitev / izdelek">
          </div>
          <div>
            <label>Znesek (€)</label>
            <input id="znesek" type="number" step="0.01" placeholder="npr. 29.90">
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btn-gen">Ustvari kodo</button>
          <button class="btn ghost" id="btn-clear">Počisti</button>
        </div>
        <div class="muted">Polja so obvezna. Če kaj manjka, bodo označena z rdečo.</div>
      </div>
    </section>

    <section class="card">
      <div class="qrbox">
        <canvas id="qr"></canvas>
        <div id="status" class="muted">Še ni generirano.</div>
      </div>
    </section>

    <footer class="muted">
      Uporablja knjižnici <code>upnqr</code> in <code>qrcode</code>. ECC=M, v=12.
    </footer>
  </div>
</div>

<script type="module">
  import { encode as upnEncode } from 'https://cdn.jsdelivr.net/npm/upnqr@1.2.2/+esm';
  import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.4/+esm';

  const $ = (id)=>document.getElementById(id);
  const toPlain = (s)=> s ? s.trim() : '';
  const normalizeIBAN = (iban)=> toPlain(iban).replace(/\s+/g,'').toUpperCase();
  const pad=(n)=>String(n).padStart(2,'0');
  const dateStr=(d)=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;

  function validate(fields){
    let ok=true;
    fields.forEach(f=>{
      const el=$(f);
      const val=toPlain(el.value);
      const invalid=!val||(f==='znesek'&&parseFloat(val)<=0);
      el.classList.toggle('err',invalid);
      if(invalid) ok=false;
    });
    return ok;
  }

  async function generate(){
    const status=$('status');
    const required=['ime_prejemnika','ulica_prejemnika','kraj_prejemnika','IBAN_prejemnika','namen_placila','znesek'];
    if(!validate(required)){status.innerHTML='<span class="err">Izpolni vsa polja.</span>';return;}
    try{
      const d=new Date();
      const ref='SI00'+dateStr(d)+'0001';
      const upn={
        polog:false,dvig:false,
        ime_placnika:'',ulica_placnika:'',kraj_placnika:'',
        znesek:parseFloat($('znesek').value).toFixed(2),
        nujno:false,koda_namena:'OTHR',
        namen_placila:$('namen_placila').value.trim(),
        rok_placila:dateStr(d),
        IBAN_prejemnika:normalizeIBAN($('IBAN_prejemnika').value),
        referenca_prejemnika:ref,
        ime_prejemnika:$('ime_prejemnika').value.trim(),
        ulica_prejemnika:$('ulica_prejemnika').value.trim(),
        kraj_prejemnika:$('kraj_prejemnika').value.trim()
      };
      const payload=upnEncode(upn);
      const canvas=$('qr');
      await QRCode.toCanvas(canvas,payload,{errorCorrectionLevel:'M',version:12,margin:4,scale:8,width:300});
      status.innerHTML='<span class="ok">✅ QR koda uspešno ustvarjena.</span>';
    }catch(e){
      console.error(e);
      status.innerHTML='<span class="err">Napaka: '+(e?.message||e)+'</span>';
    }
  }

  function clearForm(){
    ['ime_prejemnika','ulica_prejemnika','kraj_prejemnika','IBAN_prejemnika','namen_placila','znesek'].forEach(id=>{
      const el=$(id);el.value='';el.classList.remove('err');
    });
    const ctx=$('qr').getContext('2d');
    ctx.clearRect(0,0,$('qr').width,$('qr').height);
    $('status').textContent='Počistil.';
  }

  $('btn-gen').addEventListener('click',generate);
  $('btn-clear').addEventListener('click',clearForm);
</script>
</body>
</html>
